<html>
<title>Socket.Io Test Page</title>

<body>

<h1>Notifications:</h1>

<p id="out">

</p>
<button id="self_test_btn">Push for Self-Test</button>
<button id="send_server_ping">Ping</button>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
    var _out = $("#out");

    function out(message) {
        _out.append(message + "<br>");
    }

    function getAccessToken() {
        var pattern = /access_token=(\w+)&?/;
        var result = pattern.exec(window.location.href);
        console.log(result[1]);
        if (result != null) {
            return result[1];
        }
        return null;
    }


    var access_token = getAccessToken();
    var api_url = "//" + window.location.hostname + ':' + window.location.port + '/api/1/';



    $("#self_test_btn").click(function() {
        var self_test_event = {name: 'event:test', data: 'this is self test'};

        $.ajax({
            url: api_url + 'socket/event?access_token=' +access_token,
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify(self_test_event),

            success: function(result) {
                out("Result: " + JSON.stringify(result));
            },


            error: function() {
                out("Self-Test failed");
            }
        })

    });

    if (access_token != null) {
        var socket_url = "//" + window.location.hostname + ':' + window.location.port;
        var app_client_socket = io.connect(socket_url + "/?access_token=" + access_token);
        var app_all_events_socket = io.connect(socket_url + '/all_events?access_token=' + access_token);

        /* All events socket subscription */
        app_all_events_socket.on('connect', function() {
            out("all events socket connected");

            $("#send_server_ping").click(function() {
                app_client_socket.emit("ping server", "hello");
            });
        });

        app_all_events_socket.on('vent', function(event_data) {
            out("got event from server: " + JSON.stringify(event_data, null, 2));
        });

        /* Application test client socket */
        app_client_socket.on('connect', function () {
            out("Socket is connected");
        });

        app_client_socket.on('disconnect', function () {
            out("Socket is disconnected");
        });

        app_client_socket.on('event:test', function(event) {
            if (typeof event !=  'string' ) {
                event = JSON.stringify(event);
            }
            out("Got test message: " + event);
        });

        app_client_socket.on('resource_created', function(event) {
            out("Resource created: " + JSON.stringify(event));
        });

        app_client_socket.on('resource_updated', function(event) {
            out("Resource updated: " + JSON.stringify(event));
        });

        app_client_socket.on('resource_deleted', function(event) {
            out("Resource deleted: " + JSON.stringify(event));
        });
    } else {
        out("Please specify application id by adding 'app=$app_id' to query string");
    }


</script>
</body>
</html>